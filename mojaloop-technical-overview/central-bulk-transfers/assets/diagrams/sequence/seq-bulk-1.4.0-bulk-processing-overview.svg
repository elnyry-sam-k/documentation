<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2672px" preserveAspectRatio="none" style="width:1455px;height:2672px;" version="1.1" viewBox="0 0 1455 2672" width="1455px" zoomAndPan="magnify"><defs><filter height="300%" id="f1d4qykfinp5f9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="289" x="584" y="23.5352">1.4.0. Bulk Processing Handler Consume</text><rect fill="#FFFFE0" height="2626.5605" style="stroke: #A80036; stroke-width: 1.0;" width="1356" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="646.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="2454.2969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="828" y="2524.0723"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="595.7441"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="892.7813"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="1216.1973"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="1880.1348"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="625.0547"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="922.0918"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="1245.5078"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="1909.4453"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="2440.2969" style="stroke: #000000; stroke-width: 2.0;" width="1431" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="152.1738" style="stroke: #000000; stroke-width: 2.0;" width="430.5" x="157.5" y="219.3965"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="120.8633" style="stroke: #000000; stroke-width: 2.0;" width="410.5" x="167.5" y="243.707"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="594.5" x="167.5" y="385.5703"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="2011.9492" style="stroke: #000000; stroke-width: 2.0;" width="1276.5" x="157.5" y="557.123"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="128.2422" style="stroke: #000000; stroke-width: 2.0;" width="594.5" x="167.5" y="1059.6445"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="410" x="167.5" y="1621.4082"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="299.7266" style="stroke: #000000; stroke-width: 2.0;" width="1256.5" x="167.5" y="1710.3398"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="538.0059" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="167.5" y="2024.0664"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="74" x2="74" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="233.5" x2="233.5" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="578" x2="578" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="701" x2="701" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="833" x2="833" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="949" x2="949" y1="118.7754" y2="2593.0723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1323" x2="1323" y1="118.7754" y2="2593.0723"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="87.334">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="103.8223">processing</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="2592.0723"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="2596.0723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="2616.6074">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="2633.0957">processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="99.334">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="115.8223">Handler</text><ellipse cx="234" cy="69.7988" fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,57.7988,236,52.7988,234,57.7988,236,62.7988,230,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="2605.6074">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="2622.0957">Handler</text><ellipse cx="234" cy="2641.0488" fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,2629.0488,236,2624.0488,234,2629.0488,236,2634.0488,230,2629.0488" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="519" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="515" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="522" y="87.334">topic-transfer-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="547" y="103.8223">prepare</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="519" y="2592.0723"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="515" y="2596.0723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="522" y="2616.6074">topic-transfer-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="547" y="2633.0957">prepare</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="655" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="651" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="658" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="655" y="2592.0723"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="651" y="2596.0723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="658" y="2616.6074">topic-event</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="766" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="762" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="769" y="103.8223">topic-notification</text><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="766" y="2592.0723"/><rect fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="762" y="2596.0723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="769" y="2616.6074">topic-notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="914" y="115.8223">Bulk DAO</text><ellipse cx="949" cy="86.2871" fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="937" x2="961" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="914" y="2605.6074">Bulk DAO</text><ellipse cx="949" cy="2624.5605" fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="937" x2="961" y1="2638.5605" y2="2638.5605"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1275" y="115.8223">Central Store</text><path d="M1305,66.2871 C1305,56.2871 1323,56.2871 1323,56.2871 C1323,56.2871 1341,56.2871 1341,66.2871 L1341,92.2871 C1341,102.2871 1323,102.2871 1323,102.2871 C1323,102.2871 1305,102.2871 1305,92.2871 L1305,66.2871 " fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1305,66.2871 C1305,76.2871 1323,76.2871 1323,76.2871 C1323,76.2871 1341,76.2871 1341,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1275" y="2605.6074">Central Store</text><path d="M1305,2618.5605 C1305,2608.5605 1323,2608.5605 1323,2608.5605 C1323,2608.5605 1341,2608.5605 1341,2618.5605 L1341,2644.5605 C1341,2654.5605 1323,2654.5605 1323,2654.5605 C1323,2654.5605 1305,2654.5605 1305,2644.5605 L1305,2618.5605 " fill="#FEFECE" filter="url(#f1d4qykfinp5f9)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1305,2618.5605 C1305,2628.5605 1323,2628.5605 1323,2628.5605 C1323,2628.5605 1341,2628.5605 1341,2618.5605 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="2454.2969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="828" y="2524.0723"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="595.7441"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="892.7813"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="1216.1973"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="944" y="1880.1348"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="625.0547"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="922.0918"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="1245.5078"/><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1318" y="1909.4453"/><path d="M13,135.7754 L289,135.7754 L289,142.7754 L279,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2440.2969" style="stroke: #000000; stroke-width: 2.0;" width="1431" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="28" y="149.3438">Bulk Processing Handler Consume</text><polygon fill="#A80036" points="90,170.3965,80,174.3965,90,178.3965,86,174.3965" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="84" x2="228" y1="174.3965" y2="174.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="96" y="169.6543">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="109" y="169.6543">Consume message</text><path d="M157.5,219.3965 L241.5,219.3965 L241.5,226.3965 L231.5,236.3965 L157.5,236.3965 L157.5,219.3965 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="152.1738" style="stroke: #000000; stroke-width: 2.0;" width="430.5" x="157.5" y="219.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="172.5" y="232.9648">break</text><path d="M167.5,243.707 L309.5,243.707 L309.5,250.707 L299.5,260.707 L167.5,260.707 L167.5,243.707 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="120.8633" style="stroke: #000000; stroke-width: 2.0;" width="410.5" x="167.5" y="243.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="182.5" y="257.2754">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="343.5703" y2="343.5703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="343.5703" y2="356.5703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="356.5703" y2="356.5703"/><polygon fill="#A80036" points="250,352.5703,240,356.5703,250,360.5703,246,356.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="308.207">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="259" y="277.5859">Validate event - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="259" y="292.8965">type == 'bulk-processing' &amp;&amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="259" y="308.207">action IN ['prepare-duplicate','prepare','position',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="259" y="323.5176">'fulfil-duplicate','reject','commit']</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="259" y="338.8281">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="343" y="338.8281">2001</text><path d="M167.5,385.5703 L382.5,385.5703 L382.5,392.5703 L372.5,402.5703 L167.5,402.5703 L167.5,385.5703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="594.5" x="167.5" y="385.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="182.5" y="399.1387">Persist Event Information</text><polygon fill="#A80036" points="689.5,445.1914,699.5,449.1914,689.5,453.1914,693.5,449.1914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="695.5" y1="449.1914" y2="449.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="444.4492">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="259" y="444.4492">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="576.5" x="174.5" y="457.1914"/><polygon fill="#EEEEEE" points="174.5,457.1914,238.5,457.1914,238.5,464.1914,228.5,474.1914,174.5,474.1914,174.5,457.1914" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="187.5" y="471.7598">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="365.75" y="490.7598">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://TODO-input-path-to/**/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://TODO-input-path-to/**/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="523.75" y="490.7598">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="523.75" x2="555.75" y1="492.7598" y2="492.7598"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="555.75" y="490.7598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="369.75" y="506.0703"/><path d="M157.5,557.123 L316.5,557.123 L316.5,564.123 L306.5,574.123 L157.5,574.123 L157.5,557.123 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2011.9492" style="stroke: #000000; stroke-width: 2.0;" width="1276.5" x="157.5" y="557.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="172.5" y="570.6914">Process Message</text><polygon fill="#A80036" points="932,591.7441,942,595.7441,932,599.7441,936,595.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="938" y1="595.7441" y2="595.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="591.002">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="259" y="591.002">Retrieve current state of Bulk Transfer</text><polygon fill="#A80036" points="1306,621.0547,1316,625.0547,1306,629.0547,1310,625.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="954" x2="1312" y1="625.0547" y2="625.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="961" y="620.3125">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="974" y="620.3125">Retrieve current state of Bulk Transfer</text><polygon fill="#FFFFE0" filter="url(#f1d4qykfinp5f9)" points="1242,638.0547,1404,638.0547,1414,657.0547,1404,676.0547,1242,676.0547,1232,657.0547,1242,638.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1244" y="654.623">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1244" y="669.9336">bulkTransferStateChange</text><polygon fill="#A80036" points="965,698.9863,955,702.9863,965,706.9863,961,702.9863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="959" x2="1322" y1="702.9863" y2="702.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="971" y="698.2441">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="984" y="698.2441">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="1029" y="698.2441">bulkTransferInfo</text><polygon fill="#A80036" points="250,728.2969,240,732.2969,250,736.2969,246,732.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="948" y1="732.2969" y2="732.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="256" y="727.5547">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="269" y="727.5547">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="314" y="727.5547">bulkTransferInfo</text><path d="M244,745.2969 L244,816.2969 L593,816.2969 L593,755.2969 L583,745.2969 L244,745.2969 " fill="#D3D3D3" filter="url(#f1d4qykfinp5f9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,745.2969 L583,755.2969 L593,755.2969 L583,745.2969 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="250" y="762.8652">Depending on the current state of the Bulk Transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="250" y="778.1758">determine success criteria - no individual transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="250" y="793.4863">should remain in what state(s)? Use the output for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="250" y="808.7969">the following...</text><polygon fill="#A80036" points="932,888.7813,942,892.7813,932,896.7813,936,892.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="938" y1="892.7813" y2="892.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="865.0732">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="259" y="842.1074">Check if all individual transfers have been processed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="259" y="857.418">(fastest and least expensive method possible to be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="259" y="872.7285">selected as it may be repeated 999 times before</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="259" y="888.0391">the bulk transfer is ready for processing)</text><polygon fill="#A80036" points="1306,918.0918,1316,922.0918,1306,926.0918,1310,922.0918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="954" x2="1312" y1="922.0918" y2="922.0918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="961" y="917.3496">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="974" y="917.3496">Check if all individual transfers have been processed</text><polygon fill="#FFFFE0" filter="url(#f1d4qykfinp5f9)" points="1244,935.0918,1402,935.0918,1412,961.0918,1402,988.0918,1244,988.0918,1234,961.0918,1244,935.0918" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1246" y="951.6602">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1246" y="966.9707">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1246" y="982.2813">transferStateChange</text><polygon fill="#A80036" points="965,1011.334,955,1015.334,965,1019.334,961,1015.334" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="959" x2="1322" y1="1015.334" y2="1015.334"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="971" y="1010.5918">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="993" y="1010.5918">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="1038" y="1010.5918">pendingTransfersList</text><polygon fill="#A80036" points="250,1040.6445,240,1044.6445,250,1048.6445,246,1044.6445" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="948" y1="1044.6445" y2="1044.6445"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1039.9023">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="1039.9023">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="323" y="1039.9023">pendingTransfersList</text><path d="M167.5,1059.6445 L251.5,1059.6445 L251.5,1066.6445 L241.5,1076.6445 L167.5,1076.6445 L167.5,1059.6445 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="128.2422" style="stroke: #000000; stroke-width: 2.0;" width="594.5" x="167.5" y="1059.6445"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="182.5" y="1073.2129">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="266.5" y="1072.2793">[pendingTransfersList.length &gt; 0]</text><rect fill="#FFFFFF" filter="url(#f1d4qykfinp5f9)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="576.5" x="174.5" y="1101.9551"/><polygon fill="#EEEEEE" points="174.5,1101.9551,238.5,1101.9551,238.5,1108.9551,228.5,1118.9551,174.5,1118.9551,174.5,1101.9551" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="187.5" y="1116.5234">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="385.75" y="1135.5234">Persist Event Information</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="389.75" y="1150.834"/><polygon fill="#A80036" points="932,1212.1973,942,1216.1973,932,1220.1973,936,1216.1973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="938" y1="1216.1973" y2="1216.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1211.4551">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="268" y="1211.4551">Request to retrieve all individual transfers in the bulk (heavy)</text><polygon fill="#A80036" points="1306,1241.5078,1316,1245.5078,1306,1249.5078,1310,1245.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="954" x2="1312" y1="1245.5078" y2="1245.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="961" y="1240.7656">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="983" y="1240.7656">Request all individual transfers info</text><polygon fill="#FFFFE0" filter="url(#f1d4qykfinp5f9)" points="1244,1258.5078,1402,1258.5078,1412,1292.5078,1402,1327.5078,1244,1327.5078,1234,1292.5078,1244,1258.5078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1246" y="1275.0762">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1246" y="1290.3867">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1246" y="1305.6973">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1246" y="1321.0078">bulkTransfer</text><polygon fill="#A80036" points="965,1350.0605,955,1354.0605,965,1358.0605,961,1354.0605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="959" x2="1322" y1="1354.0605" y2="1354.0605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="971" y="1349.3184">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="993" y="1349.3184">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1038" y="1349.3184">individualTransfersInfo</text><polygon fill="#A80036" points="250,1379.3711,240,1383.3711,250,1387.3711,246,1383.3711" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="948" y1="1383.3711" y2="1383.3711"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1378.6289">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="1378.6289">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="323" y="1378.6289">individualTransfersInfo</text><path d="M244,1396.3711 L244,1605.3711 L439,1605.3711 L439,1406.3711 L429,1396.3711 L244,1396.3711 " fill="#D3D3D3" filter="url(#f1d4qykfinp5f9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M429,1396.3711 L429,1406.3711 L439,1406.3711 L429,1396.3711 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="250" y="1413.9395">let receivedPrepareList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="250" y="1429.25">let reservedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="250" y="1444.5605">let receivedFulfilList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="250" y="1459.8711">let committedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="250" y="1475.1816">let failedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="250" y="1490.4922">let reservedTimeoutList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="250" y="1505.8027">let receivedRejectList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1521.1133">let abortedRejectedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="250" y="1536.4238">let receivedErrorList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="250" y="1551.7344">let abortedErrorList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1567.0449">let expiredPreparedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="250" y="1582.3555">let expiredReservedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="250" y="1597.666">let invalidList = []</text><path d="M167.5,1621.4082 L241.5,1621.4082 L241.5,1628.4082 L231.5,1638.4082 L167.5,1638.4082 L167.5,1621.4082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="410" x="167.5" y="1621.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="182.5" y="1634.9766">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="316" x="256.5" y="1634.043">[for each individualTransfer in individualTransfersInfo]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="1675.3398" y2="1675.3398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="1675.3398" y2="1688.3398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="1688.3398" y2="1688.3398"/><polygon fill="#A80036" points="250,1684.3398,240,1688.3398,250,1692.3398,246,1688.3398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1662.9424">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="268" y="1655.2871">Push individualTransfer to the appropriate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="268" y="1670.5977">list according to the transferState</text><path d="M167.5,1710.3398 L374.5,1710.3398 L374.5,1717.3398 L364.5,1727.3398 L167.5,1727.3398 L167.5,1710.3398 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="299.7266" style="stroke: #000000; stroke-width: 2.0;" width="1256.5" x="167.5" y="1710.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="182.5" y="1723.9082">Process Agregated Data</text><path d="M244,1732.6504 L244,1849.6504 L559,1849.6504 L559,1742.6504 L549,1732.6504 L244,1732.6504 " fill="#D3D3D3" filter="url(#f1d4qykfinp5f9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M549,1732.6504 L549,1742.6504 L559,1742.6504 L549,1732.6504 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="250" y="1750.2188">Depending on the list counts, decide the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="250" y="1765.5293">following state for the entrire Bulk Transfer:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="250" y="1780.8398">PENDING, PENDING_INVALID, ACCEPTED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="250" y="1796.1504">PROCESSING, COMPLETED, REJECTED, INVALID.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="254" y="1811.4609"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="250" y="1826.7715">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="291" y="1826.7715">: Reduce the above list to the possible</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="250" y="1842.082">states from Bulk Processing Handler.</text><polygon fill="#A80036" points="932,1876.1348,942,1880.1348,932,1884.1348,936,1880.1348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="938" y1="1880.1348" y2="1880.1348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1875.3926">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="268" y="1875.3926">Persist Bulk Transfer state</text><polygon fill="#A80036" points="1306,1905.4453,1316,1909.4453,1306,1913.4453,1310,1909.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="954" x2="1312" y1="1909.4453" y2="1909.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="961" y="1904.7031">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="983" y="1904.7031">Persist Bulk Transfer state</text><polygon fill="#FFFFE0" filter="url(#f1d4qykfinp5f9)" points="1242,1952.4453,1404,1952.4453,1414,1963.4453,1404,1975.4453,1242,1975.4453,1232,1963.4453,1242,1952.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1244" y="1969.0137">bulkTransferStateChange</text><polygon fill="#A80036" points="250,1998.0664,240,2002.0664,250,2006.0664,246,2002.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="948" y1="2002.0664" y2="2002.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1997.3242">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="278" y="1997.3242">Return success</text><path d="M167.5,2024.0664 L359.5,2024.0664 L359.5,2031.0664 L349.5,2041.0664 L167.5,2041.0664 L167.5,2024.0664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="538.0059" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="167.5" y="2024.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="182.5" y="2037.6348">Send Bulk Notification</text><path d="M244,2046.377 L244,2086.377 L613,2086.377 L613,2056.377 L603,2046.377 L244,2046.377 " fill="#D3D3D3" filter="url(#f1d4qykfinp5f9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M603,2046.377 L603,2056.377 L613,2056.377 L603,2046.377 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="250" y="2063.9453">Use individualTransfersInfo to complete individual</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="250" y="2079.2559">transfer results to be included in the response payload.</text><path d="M244,2100.998 L244,2477.998 L635,2477.998 L635,2110.998 L625,2100.998 L244,2100.998 " fill="#FFFF00" filter="url(#f1d4qykfinp5f9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M625,2100.998 L625,2110.998 L635,2110.998 L625,2100.998 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="250" y="2118.5664">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="2133.877">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="266" y="2149.1875">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="266" y="2164.498">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="266" y="2179.8086">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="266" y="2195.1191">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="266" y="2210.4297">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="282" y="2225.7402">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="282" y="2241.0508">payload: &lt;bulkTransferWithIndividualTransferResult&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="266" y="2256.3613">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="266" y="2271.6719">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="282" y="2286.9824">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="298" y="2302.293">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="298" y="2317.6035">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="298" y="2332.9141">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="298" y="2348.2246">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="298" y="2363.5352">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="298" y="2378.8457">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="314" y="2394.1563">status: 'success',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="314" y="2409.4668">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="298" y="2424.7773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="282" y="2440.0879">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="266" y="2455.3984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="2470.709">}</text><polygon fill="#A80036" points="816,2520.0723,826,2524.0723,816,2528.0723,820,2524.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="822" y1="2524.0723" y2="2524.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="2511.6748">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="268" y="2504.0195">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="268" y="2519.3301">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="352" y="2519.3301">2003</text><!--
@startuml
title 1.4.0. Bulk Processing Handler Consume

autonumber


collections "topic-bulk-\nprocessing" as TOPIC_BULK_PROCESSING
control "Bulk Processing\nHandler" as BULK_PROC_HANDLER
collections "topic-transfer-\nprepare" as TOPIC_TRANSFER_PREPARE
collections "topic-event" as TOPIC_EVENTS
collections "topic-notification" as TOPIC_NOTIFICATION
entity "Bulk DAO" as BULK_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_BULK_PROCESSING
    participant BULK_PROC_HANDLER
    participant TOPIC_TRANSFER_PREPARE
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATION
    participant BULK_DAO
    participant DB
end box

activate BULK_PROC_HANDLER
group Bulk Processing Handler Consume
    TOPIC_BULK_PROCESSING <- BULK_PROC_HANDLER: Consume message
    activate TOPIC_BULK_PROCESSING
    deactivate TOPIC_BULK_PROCESSING

    break
        group Validate Event
            BULK_PROC_HANDLER <-> BULK_PROC_HANDLER: Validate event - Rule:\ntype == 'bulk-processing' && \naction IN ['prepare-duplicate','prepare','position',\n'fulfil-duplicate','reject','commit']\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        BULK_PROC_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over BULK_PROC_HANDLER, TOPIC_EVENTS:  Event Handler Consume {[[https://TODO-input-path-to/**/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    group Process Message
        BULK_PROC_HANDLER -> BULK_DAO: Retrieve current state of Bulk Transfer
        activate BULK_DAO
        BULK_DAO -> DB: Retrieve current state of Bulk Transfer
        activate DB
        hnote over DB #lightyellow
            bulkTransfer
            bulkTransferStateChange
        end note
        BULK_DAO <- - DB: Return **bulkTransferInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferInfo**
        deactivate BULK_DAO

        note right of BULK_PROC_HANDLER #lightgrey
            Depending on the current state of the Bulk Transfer,
            determine success criteria - no individual transfer
            should remain in what state(s)? Use the output for
            the following...
        end note

        BULK_PROC_HANDLER -> BULK_DAO: Check if all individual transfers have been processed\n(fastest and least expensive method possible to be\nselected as it may be repeated 999 times before\nthe bulk transfer is ready for processing)
        activate BULK_DAO
        BULK_DAO -> DB: Check if all individual transfers have been processed
        activate DB
        hnote over DB #lightyellow
            bulkTransferAssociation
            transfer
            transferStateChange
        end note
        BULK_DAO <- - DB: Return **pendingTransfersList**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **pendingTransfersList**
        deactivate BULK_DAO

        break pendingTransfersList.length > 0
            |||
            ref over BULK_PROC_HANDLER, TOPIC_EVENTS: Persist Event Information\n
            |||
        end

        BULK_PROC_HANDLER -> BULK_DAO: Request to retrieve all individual transfers in the bulk (heavy)
        activate BULK_DAO
        BULK_DAO -> DB: Request all individual transfers info
        activate DB
        hnote over DB #lightyellow
            bulkTransferAssociation
            transfer
            transferStateChange
            bulkTransfer
        end note
        BULK_DAO <- - DB: Return **individualTransfersInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **individualTransfersInfo**
        deactivate BULK_DAO

        note right of BULK_PROC_HANDLER #lightgrey
            let receivedPrepareList = []
            let reservedList = []
            let receivedFulfilList = []
            let committedList = []
            let failedList = []
            let reservedTimeoutList = []
            let receivedRejectList = []
            let abortedRejectedList = []
            let receivedErrorList = []
            let abortedErrorList = []
            let expiredPreparedList = []
            let expiredReservedList = []
            let invalidList = []
        end note
        loop for each individualTransfer in individualTransfersInfo
            BULK_PROC_HANDLER -> BULK_PROC_HANDLER: Push individualTransfer to the appropriate\nlist according to the transferState
        end

        group Process Agregated Data
            note right of BULK_PROC_HANDLER #lightgrey
                Depending on the list counts, decide the
                following state for the entrire Bulk Transfer:
                PENDING, PENDING_INVALID, ACCEPTED,
                PROCESSING, COMPLETED, REJECTED, INVALID.

                **<color #red>TODO</color>**: Reduce the above list to the possible
                states from Bulk Processing Handler.
            end note

            BULK_PROC_HANDLER -> BULK_DAO: Persist Bulk Transfer state
            activate BULK_DAO
            BULK_DAO -> DB: Persist Bulk Transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                bulkTransferStateChange
            end note
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO
        end

        group Send Bulk Notification
            note right of BULK_PROC_HANDLER #lightgrey
                Use individualTransfersInfo to complete individual
                transfer results to be included in the response payload.
            end note
            note right of BULK_PROC_HANDLER #yellow
                Message:
                {
                    id: <bulkTransferMessage.bulkTransferId>
                    from: <ledgerName>,
                    to: <bulkTransferMessage.payerFsp>,
                    type: application/json
                    content: {
                        headers: <bulkTransferHeaders>,
                        payload: <bulkTransferWithIndividualTransferResult>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: bulk-notification,
                            action: bulk-notification,
                            createdAt: <timestamp>,
                            state: {
                                status: 'success',
                                code: 0
                            }
                        }
                    }
                }
            end note
            BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TOPIC_NOTIFICATION
            deactivate TOPIC_NOTIFICATION
        end
    end
end
deactivate BULK_PROC_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>