<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6926px" preserveAspectRatio="none" style="width:1949px;height:6926px;" version="1.1" viewBox="0 0 1949 6926" width="1949px" zoomAndPan="magnify"><defs><filter height="300%" id="fqhcfjpcp8f7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="701" x="625" y="23.5352">2.2.1. Fulfil Handler Consume (Success) (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="6881.2441" style="stroke: #A80036; stroke-width: 1.0;" width="1786" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="871.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="6713.957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="5148.959"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="5614.6777"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="2146.123"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="2765.6602"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="3457.5078"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="6322.5254"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="1649.7832"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6788.2441"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="681.1875"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="1004.2246"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="3568.084"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="3772.9473"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4102.6738"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4337.4688"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4574.9531"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="710.498"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="1033.5352"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="3597.3945"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="3802.2578"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4131.9844"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4366.7793"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4604.2637"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="5705.543" style="stroke: #000000; stroke-width: 2.0;" width="1925" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="5674.2324" style="stroke: #000000; stroke-width: 2.0;" width="1905" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="571" x="308" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="551" x="318" y="265.5293"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="731" x="318" y="361.4609"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="467.7031"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="3120.0703" style="stroke: #000000; stroke-width: 2.0;" width="1640" x="278" y="584.9453"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="2792.3438" style="stroke: #000000; stroke-width: 2.0;" width="1603" x="288" y="905.6719"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="2353.7305" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="298" y="1155.7773"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="1011.0352" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="1180.0879"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="979.7246" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="1204.3984"/><rect fill="#FFFFFF" height="496.3398" style="stroke: none; stroke-width: 1.0;" width="986" x="318" y="1687.7832"/><rect fill="#FFFFFF" height="619.5371" style="stroke: none; stroke-width: 1.0;" width="1026" x="298" y="2198.123"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="590.582" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="2220.0781"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="559.2715" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="2244.3887"/><rect fill="#FFFFFF" height="481.0293" style="stroke: none; stroke-width: 1.0;" width="986" x="318" y="2322.6309"/><rect fill="#FFFFFF" height="103.8867" style="stroke: none; stroke-width: 1.0;" width="1026" x="298" y="2817.6602"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="314" x="318" y="2839.6152"/><rect fill="#FFFFFF" height="587.9609" style="stroke: none; stroke-width: 1.0;" width="1026" x="298" y="2921.5469"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="571.9609" style="stroke: #000000; stroke-width: 2.0;" width="896" x="308" y="2930.5469"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="540.6504" style="stroke: #000000; stroke-width: 2.0;" width="876" x="318" y="2954.8574"/><rect fill="#FFFFFF" height="481.0293" style="stroke: none; stroke-width: 1.0;" width="876" x="318" y="3014.4785"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1603" x="288" y="3516.5078"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="2051.5488" style="stroke: #000000; stroke-width: 2.0;" width="1570" x="298" y="3719.0156"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1545" x="308" y="4024.4316"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1525" x="318" y="4048.7422"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1523" x="318" y="4283.5371"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="1266.8535" style="stroke: #000000; stroke-width: 2.0;" width="1550" x="308" y="4496.7109"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1530" x="318" y="4521.0215"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="933.793" style="stroke: #000000; stroke-width: 2.0;" width="657" x="318" y="4718.8848"/><rect fill="#FFFFFF" height="465.7188" style="stroke: none; stroke-width: 1.0;" width="657" x="318" y="5186.959"/><rect fill="#FFFFFF" height="103.8867" style="stroke: none; stroke-width: 1.0;" width="1550" x="308" y="5659.6777"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="382" x="318" y="5681.6328"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1905" x="23" y="5777.5645"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="980.4141" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="5852.8301"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="949.1035" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="5877.1406"/><rect fill="#FFFFFF" height="465.7188" style="stroke: none; stroke-width: 1.0;" width="986" x="318" y="6360.5254"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="377" x2="377" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="895" x2="895" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1007" x2="1007" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1116" x2="1116" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1244" x2="1244" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1352" x2="1352" y1="116.2871" y2="6850.2441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1763" x2="1763" y1="116.2871" y2="6850.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="6849.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="6853.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="6873.7793">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="328" y="113.334">Fulfil Handler</text><ellipse cx="377" cy="83.7988" fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,71.7988,379,66.7988,377,71.7988,379,76.7988,373,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="328" y="6862.7793">Fulfil Handler</text><ellipse cx="377" cy="6881.7324" fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,6869.7324,379,6864.7324,377,6869.7324,379,6874.7324,373,6869.7324" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="829" y="60.3105"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="825" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="870" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="832" y="101.334">transfer-position</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="829" y="6849.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="825" y="6853.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="870" y="6873.7793">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="832" y="6890.2676">transfer-position</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="979" y="60.3105"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="975" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="982" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="984.5" y="101.334">event</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="979" y="6849.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="975" y="6853.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="982" y="6873.7793">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="984.5" y="6890.2676">event</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1053" y="60.3105"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1049" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1091.5" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1056" y="101.334">bulk-processing</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1053" y="6849.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1049" y="6853.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1091.5" y="6873.7793">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1056" y="6890.2676">bulk-processing</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1198" y="60.3105"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1194" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1219" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1201" y="101.334">notification</text><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1198" y="6849.2441"/><rect fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1194" y="6853.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1219" y="6873.7793">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1201" y="6890.2676">notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1304" y="113.334">Position DAO</text><ellipse cx="1352" cy="83.7988" fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1340" x2="1364" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1304" y="6862.7793">Position DAO</text><ellipse cx="1352" cy="6881.7324" fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1340" x2="1364" y1="6895.7324" y2="6895.7324"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1715" y="113.334">Central Store</text><path d="M1745,63.7988 C1745,53.7988 1763,53.7988 1763,53.7988 C1763,53.7988 1781,53.7988 1781,63.7988 L1781,89.7988 C1781,99.7988 1763,99.7988 1763,99.7988 C1763,99.7988 1745,99.7988 1745,89.7988 L1745,63.7988 " fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1745,63.7988 C1745,73.7988 1763,73.7988 1763,73.7988 C1763,73.7988 1781,73.7988 1781,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1715" y="6862.7793">Central Store</text><path d="M1745,6875.7324 C1745,6865.7324 1763,6865.7324 1763,6865.7324 C1763,6865.7324 1781,6865.7324 1781,6875.7324 L1781,6901.7324 C1781,6911.7324 1763,6911.7324 1763,6911.7324 C1763,6911.7324 1745,6911.7324 1745,6901.7324 L1745,6875.7324 " fill="#FEFECE" filter="url(#fqhcfjpcp8f7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1745,6875.7324 C1745,6885.7324 1763,6885.7324 1763,6885.7324 C1763,6885.7324 1781,6885.7324 1781,6875.7324 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="6713.957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="5148.959"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="5614.6777"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="2146.123"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="2765.6602"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="3457.5078"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1111.5" y="6322.5254"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="1649.7832"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6788.2441"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="681.1875"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="1004.2246"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="3568.084"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="3772.9473"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4102.6738"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4337.4688"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1347" y="4574.9531"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="710.498"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="1033.5352"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="3597.3945"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="3802.2578"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4131.9844"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4366.7793"/><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1758" y="4604.2637"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5705.543" style="stroke: #000000; stroke-width: 2.0;" width="1925" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5674.2324" style="stroke: #000000; stroke-width: 2.0;" width="1905" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="371" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="119" y="191.4766">Consume Fulfil event message for Payer</text><path d="M308,241.2188 L392,241.2188 L392,248.2188 L382,258.2188 L308,258.2188 L308,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="571" x="308" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="323" y="254.7871">break</text><path d="M318,265.5293 L460,265.5293 L460,272.5293 L450,282.5293 L318,282.5293 L318,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="551" x="318" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="333" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="393,328.4609,383,332.4609,393,336.4609,389,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="402" y="299.4082">Validate event - Rule: type IN ['fulfil','bulk-fulfil'] &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="402" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="486" y="314.7188">2001</text><path d="M318,361.4609 L533,361.4609 L533,368.4609 L523,378.4609 L318,378.4609 L318,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="731" x="318" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="333" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="995,396.082,1005,400.082,995,404.082,999,400.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1001" y1="400.082" y2="400.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="395.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="402" y="395.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="713" x="325" y="408.082"/><polygon fill="#EEEEEE" points="325,408.082,389,408.082,389,415.082,379,425.082,325,425.082,325,408.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="338" y="422.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="586.5" y="441.6504">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="744.5" y="441.6504">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="744.5" x2="776.5" y1="443.6504" y2="443.6504"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="776.5" y="441.6504">}</text><path d="M318,467.7031 L540,467.7031 L540,474.7031 L530,484.7031 L318,484.7031 L318,467.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="467.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="333" y="481.2715">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="968" x="325" y="510.0137"/><polygon fill="#EEEEEE" points="325,510.0137,389,510.0137,389,517.0137,379,527.0137,325,527.0137,325,510.0137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="338" y="524.582">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="555.5" y="543.582">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="773.5" y="543.582">FSPIOP-Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="895.5" y="543.582">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="159" x="899.5" y="543.582">seq-signature-validation</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="899.5" x2="1058.5" y1="545.582" y2="545.582"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1058.5" y="543.582">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="555.5" y="558.8926">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="639.5" y="558.8926">3105/3106</text><path d="M278,584.9453 L625,584.9453 L625,591.9453 L615,601.9453 L278,601.9453 L278,584.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3120.0703" style="stroke: #000000; stroke-width: 2.0;" width="1640" x="278" y="584.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="293" y="598.5137">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="623.5664" y2="623.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="623.5664" y2="636.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="636.5664" y2="636.5664"/><polygon fill="#A80036" points="393,632.5664,383,636.5664,393,640.5664,389,636.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="618.8242">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="402" y="618.8242">Generate transferFulfilmentId uuid</text><polygon fill="#A80036" points="1335,677.1875,1345,681.1875,1335,685.1875,1339,681.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="681.1875" y2="681.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="668.79">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="402" y="661.1348">Request to retrieve transfer fulfilment hashes by transferId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="676.4453">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="676.4453">2003</text><polygon fill="#A80036" points="1746,706.498,1756,710.498,1746,714.498,1750,710.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="710.498" y2="710.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1364" y="705.7559">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="1377" y="705.7559">Request Transfer fulfilment duplicate message hashes</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1627,723.498,1898,723.498,1908,749.498,1898,776.498,1627,776.498,1617,749.498,1627,723.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1629" y="740.0664">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1629" y="755.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="1669" y="755.377">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="1629" y="770.6875">WHERE transferId = request.params.id</text><polygon fill="#A80036" points="1368,799.7402,1358,803.7402,1368,807.7402,1364,803.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1362" x2="1762" y1="803.7402" y2="803.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1374" y="798.998">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1387" y="798.998">Return existing hashes</text><polygon fill="#A80036" points="393,829.0508,383,833.0508,393,837.0508,389,833.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="833.0508" y2="833.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="828.3086">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="412" y="828.3086">Return (list of) transfer fulfil messages hash(es)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="877.6719" y2="877.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="877.6719" y2="890.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="890.6719" y2="890.6719"/><polygon fill="#A80036" points="393,886.6719,383,890.6719,393,894.6719,389,890.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="865.2744">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="402" y="857.6191">Loop the list of returned hashes and compare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="402" y="872.9297">each entry with the calculated message hash</text><path d="M288,905.6719 L350,905.6719 L350,912.6719 L340,922.6719 L288,922.6719 L288,905.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2792.3438" style="stroke: #000000; stroke-width: 2.0;" width="1603" x="288" y="905.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="303" y="919.2402">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="365" y="918.3066">[Hash matched]</text><polygon fill="#A80036" points="995,955.6035,1005,959.6035,995,963.6035,999,959.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1001" y1="959.6035" y2="959.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="947.2061">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="411" y="939.5508">Publish event information (for duplicate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="411" y="954.8613">(Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="573" y="954.8613">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="573" x2="605" y1="956.8613" y2="956.8613"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="605" y="954.8613">} )</text><polygon fill="#A80036" points="1335,1000.2246,1345,1004.2246,1335,1008.2246,1339,1004.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="1004.2246" y2="1004.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="991.8271">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="411" y="984.1719">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="999.4824">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="999.4824">2003</text><polygon fill="#A80036" points="1746,1029.5352,1756,1033.5352,1746,1037.5352,1750,1033.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="1033.5352" y2="1033.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="1028.793">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1386" y="1028.793">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1697,1046.5352,1828,1046.5352,1838,1065.5352,1828,1084.5352,1697,1084.5352,1687,1065.5352,1697,1046.5352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1699" y="1063.1035">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1699" y="1078.4141">transferStateChange</text><polygon fill="#A80036" points="1368,1107.4668,1358,1111.4668,1368,1115.4668,1364,1111.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1362" x2="1762" y1="1111.4668" y2="1111.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1374" y="1106.7246">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1396" y="1106.7246">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="393,1136.7773,383,1140.7773,393,1144.7773,389,1140.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="1140.7773" y2="1140.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1136.0352">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="421" y="1136.0352">Return Transfer Fulfilment and Transfer state</text><path d="M298,1155.7773 L360,1155.7773 L360,1162.7773 L350,1172.7773 L298,1172.7773 L298,1155.7773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2353.7305" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="298" y="1155.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="313" y="1169.3457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="185" x="375" y="1168.4121">[transferFulfilment.isValid == 0]</text><path d="M308,1180.0879 L392,1180.0879 L392,1187.0879 L382,1197.0879 L308,1197.0879 L308,1180.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1011.0352" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="1180.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="323" y="1193.6563">break</text><path d="M318,1204.3984 L380,1204.3984 L380,1211.3984 L370,1221.3984 L318,1221.3984 L318,1204.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="979.7246" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="1204.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="333" y="1217.9668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="395" y="1217.0332">[If type == 'fulfil']</text><path d="M387,1226.709 L387,1603.709 L696,1603.709 L696,1236.709 L686,1226.709 L387,1226.709 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,1226.709 L686,1236.709 L696,1236.709 L686,1226.709 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="1244.2773">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1259.5879">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="1274.8984">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="1290.209">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="1305.5195">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="1320.8301">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="1336.1406">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="1351.4512">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="1366.7617">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="1382.0723">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="1397.3828">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="1412.6934">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="1428.0039">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="1443.3145">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="441" y="1458.625">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="441" y="1473.9355">action: fulfil-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="1489.2461">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="1504.5566">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="1519.8672">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="1535.1777">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="1550.4883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1565.7988">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1581.1094">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1596.4199">}</text><polygon fill="#A80036" points="1227,1645.7832,1237,1649.7832,1227,1653.7832,1231,1649.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1233" y1="1649.7832" y2="1649.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1637.3857">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="411" y="1629.7305">Publish Notification event for Payee - Modified Request</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="1645.041">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="1645.041">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="318" x2="1304" y1="1688.7832" y2="1688.7832"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="323" y="1699.418">[If type == 'bulk-fulfil']</text><path d="M387,1707.7383 L387,2084.7383 L696,2084.7383 L696,1717.7383 L686,1707.7383 L387,1707.7383 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,1707.7383 L686,1717.7383 L696,1717.7383 L686,1707.7383 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="1725.3066">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1740.6172">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="1755.9277">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="1771.2383">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="1786.5488">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="1801.8594">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="1817.1699">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="1832.4805">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="1847.791">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="1863.1016">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="1878.4121">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="1893.7227">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="1909.0332">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="1924.3438">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="441" y="1939.6543">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="441" y="1954.9648">action: fulfil-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="1970.2754">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="1985.5859">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="2000.8965">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="2016.207">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="2031.5176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2046.8281">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2062.1387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2077.4492">}</text><polygon fill="#A80036" points="1099.5,2142.123,1109.5,2146.123,1099.5,2150.123,1103.5,2146.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1105.5" y1="2146.123" y2="2146.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2126.0703">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="411" y="2110.7598">Publish Notification event for Payee - Modified Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="411" y="2126.0703">3106 to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="2141.3809">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="2141.3809">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="298" x2="1324" y1="2199.123" y2="2199.123"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="303" y="2209.7578">[transferState IN ['COMMITTED', 'ABORTED']]</text><path d="M308,2220.0781 L392,2220.0781 L392,2227.0781 L382,2237.0781 L308,2237.0781 L308,2220.0781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="590.582" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="2220.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="323" y="2233.6465">break</text><path d="M318,2244.3887 L380,2244.3887 L380,2251.3887 L370,2261.3887 L318,2261.3887 L318,2244.3887 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="559.2715" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="2244.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="333" y="2257.957">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="395" y="2257.0234">[If type == 'fulfil']</text><rect fill="#FFFFFF" filter="url(#fqhcfjpcp8f7)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="968" x="325" y="2261.6992"/><polygon fill="#EEEEEE" points="325,2261.6992,389,2261.6992,389,2268.6992,379,2278.6992,325,2278.6992,325,2261.6992" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="338" y="2276.2676">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="660.5" y="2295.2676">Send notification to Participant (Payee) {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="43" x="910.5" y="2295.2676">1.1.4.a</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="910.5" x2="953.5" y1="2297.2676" y2="2297.2676"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="953.5" y="2295.2676">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="664.5" y="2310.5781"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="318" x2="1304" y1="2323.6309" y2="2323.6309"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="323" y="2334.2656">[If type == 'bulk-fulfil']</text><path d="M387,2342.5859 L387,2719.5859 L696,2719.5859 L696,2352.5859 L686,2342.5859 L387,2342.5859 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2342.5859 L686,2352.5859 L696,2352.5859 L686,2342.5859 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2360.1543">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2375.4648">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2390.7754">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2406.0859">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2421.3965">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2436.707">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2452.0176">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2467.3281">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2482.6387">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2497.9492">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2513.2598">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2528.5703">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2543.8809">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2559.1914">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="441" y="2574.502">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="441" y="2589.8125">action: fulfil-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2605.123">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="2620.4336">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="2635.7441">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="2651.0547">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="2666.3652">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2681.6758">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2696.9863">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2712.2969">}</text><polygon fill="#A80036" points="1099.5,2761.6602,1109.5,2765.6602,1099.5,2769.6602,1103.5,2765.6602" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1105.5" y1="2765.6602" y2="2765.6602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2753.2627">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="411" y="2745.6074">Publish Notification event for Payee to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="2760.918">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="2760.918">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="298" x2="1324" y1="2818.6602" y2="2818.6602"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="303" y="2829.2949">[transferState NOT 'RESERVED']</text><path d="M318,2839.6152 L402,2839.6152 L402,2846.6152 L392,2856.6152 L318,2856.6152 L318,2839.6152 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="314" x="318" y="2839.6152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="333" y="2853.1836">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="2893.5469" y2="2893.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="2893.5469" y2="2906.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="2906.5469" y2="2906.5469"/><polygon fill="#A80036" points="393,2902.5469,383,2906.5469,393,2910.5469,389,2906.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2881.1494">18</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="411" y="2873.4941">Reference: Failure in validation</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2888.8047">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2888.8047">2001</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="298" x2="1324" y1="2922.5469" y2="2922.5469"/><path d="M308,2930.5469 L392,2930.5469 L392,2937.5469 L382,2947.5469 L308,2947.5469 L308,2930.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="571.9609" style="stroke: #000000; stroke-width: 2.0;" width="896" x="308" y="2930.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="323" y="2944.1152">break</text><path d="M318,2954.8574 L380,2954.8574 L380,2961.8574 L370,2971.8574 L318,2971.8574 L318,2954.8574 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="540.6504" style="stroke: #000000; stroke-width: 2.0;" width="876" x="318" y="2954.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="333" y="2968.4258">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="395" y="2967.4922">[If type == 'fulfil']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="2993.4785" y2="2993.4785"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="2993.4785" y2="3006.4785"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="3006.4785" y2="3006.4785"/><polygon fill="#A80036" points="393,3002.4785,383,3006.4785,393,3010.4785,389,3006.4785" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2988.7363">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="411" y="2988.7363">Allow previous request to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="318" x2="1194" y1="3015.4785" y2="3015.4785"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="323" y="3026.1133">[If type == 'bulk-fulfil']</text><path d="M387,3034.4336 L387,3411.4336 L696,3411.4336 L696,3044.4336 L686,3034.4336 L387,3034.4336 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,3034.4336 L686,3044.4336 L696,3044.4336 L686,3034.4336 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="3052.002">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3067.3125">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="3082.623">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="3097.9336">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="3113.2441">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="3128.5547">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="3143.8652">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="3159.1758">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="3174.4863">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="3189.7969">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="3205.1074">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="3220.418">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="3235.7285">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="3251.0391">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="441" y="3266.3496">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="441" y="3281.6602">action: fulfil-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="3296.9707">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="3312.2813">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="3327.5918">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="3342.9023">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="3358.2129">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3373.5234">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3388.834">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3404.1445">}</text><polygon fill="#A80036" points="1099.5,3453.5078,1109.5,3457.5078,1099.5,3461.5078,1103.5,3457.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1105.5" y1="3457.5078" y2="3457.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3445.1104">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="411" y="3437.4551">Publish Notification event for Payee to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="3452.7656">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="3452.7656">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="288" x2="1891" y1="3517.5078" y2="3517.5078"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="293" y="3528.1426">[Hash not matched]</text><polygon fill="#A80036" points="1335,3564.084,1345,3568.084,1335,3572.084,1339,3568.084" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="3568.084" y2="3568.084"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3555.6865">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="411" y="3548.0313">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="3563.3418">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="3563.3418">2003</text><polygon fill="#A80036" points="1746,3593.3945,1756,3597.3945,1746,3601.3945,1750,3597.3945" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="3597.3945" y2="3597.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="3592.6523">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1386" y="3592.6523">Persist hash</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1655,3640.3945,1871,3640.3945,1881,3651.3945,1871,3663.3945,1655,3663.3945,1645,3651.3945,1655,3640.3945" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="1657" y="3656.9629">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="393,3686.0156,383,3690.0156,393,3694.0156,389,3690.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="3690.0156" y2="3690.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="3685.2734">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="3685.2734">Return success</text><path d="M298,3719.0156 L612,3719.0156 L612,3726.0156 L602,3736.0156 L298,3736.0156 L298,3719.0156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2051.5488" style="stroke: #000000; stroke-width: 2.0;" width="1570" x="298" y="3719.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="313" y="3732.584">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1335,3768.9473,1345,3772.9473,1335,3776.9473,1339,3772.9473" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="3772.9473" y2="3772.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3760.5498">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="411" y="3752.8945">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="3768.2051">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="3768.2051">2003</text><polygon fill="#A80036" points="1746,3798.2578,1756,3802.2578,1746,3806.2578,1750,3802.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="3802.2578" y2="3802.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="3797.5156">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1386" y="3797.5156">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1736,3815.2578,1789,3815.2578,1799,3826.2578,1789,3838.2578,1736,3838.2578,1726,3826.2578,1736,3815.2578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1738" y="3831.8262">transfer</text><polygon fill="#A80036" points="1368,3860.8789,1358,3864.8789,1368,3868.8789,1364,3864.8789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1362" x2="1762" y1="3864.8789" y2="3864.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1374" y="3860.1367">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1400" y="3860.1367"/><polygon fill="#A80036" points="393,3890.1895,383,3894.1895,393,3898.1895,389,3894.1895" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="3894.1895" y2="3894.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="3889.4473">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="421" y="3889.4473">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="3938.8105" y2="3938.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="3938.8105" y2="3951.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="3951.8105" y2="3951.8105"/><polygon fill="#A80036" points="393,3947.8105,383,3951.8105,393,3955.8105,389,3951.8105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3926.4131">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="411" y="3918.7578">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="3934.0684">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="3934.0684">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="3996.4316" y2="3996.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="3996.4316" y2="4009.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="4009.4316" y2="4009.4316"/><polygon fill="#A80036" points="393,4005.4316,383,4009.4316,393,4013.4316,389,4009.4316" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3984.0342">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="411" y="3976.3789">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="3991.6895">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="3991.6895">3303</text><path d="M308,4024.4316 L375,4024.4316 L375,4031.4316 L365,4041.4316 L308,4041.4316 L308,4024.4316 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1545" x="308" y="4024.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="323" y="4038">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="390" y="4037.0664">[Transfer.ilpCondition validate successful]</text><path d="M318,4048.7422 L605,4048.7422 L605,4055.7422 L595,4065.7422 L318,4065.7422 L318,4048.7422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1525" x="318" y="4048.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="333" y="4062.3105">Request current Settlement Window</text><polygon fill="#A80036" points="1335,4098.6738,1345,4102.6738,1335,4106.6738,1339,4102.6738" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="4102.6738" y2="4102.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="4090.2764">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="411" y="4082.6211">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="4097.9316">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="4097.9316">2003</text><polygon fill="#A80036" points="1746,4127.9844,1756,4131.9844,1746,4135.9844,1750,4131.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="4131.9844" y2="4131.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="4127.2422">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1386" y="4127.2422">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1703,4144.9844,1823,4144.9844,1833,4155.9844,1823,4167.9844,1703,4167.9844,1693,4155.9844,1703,4144.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1705" y="4161.5527">settlementWindow</text><polygon fill="#A80036" points="1368,4190.6055,1358,4194.6055,1368,4198.6055,1364,4194.6055" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1362" x2="1762" y1="4194.6055" y2="4194.6055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1374" y="4189.8633">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1400" y="4189.8633"/><polygon fill="#A80036" points="393,4250.5371,383,4254.5371,393,4258.5371,389,4254.5371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="4254.5371" y2="4254.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="4234.4844">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="421" y="4219.1738">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="421" y="4234.4844">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="462" y="4234.4844">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="421" y="4249.7949">state are updated to the next settlement window</text><path d="M318,4283.5371 L478,4283.5371 L478,4290.5371 L468,4300.5371 L318,4300.5371 L318,4283.5371 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1523" x="318" y="4283.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="333" y="4297.1055">Persist fulfilment</text><polygon fill="#A80036" points="1335,4333.4688,1345,4337.4688,1335,4341.4688,1339,4337.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="4337.4688" y2="4337.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="4325.0713">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="411" y="4317.416">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="4332.7266">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="4332.7266">2003</text><polygon fill="#A80036" points="1746,4362.7793,1756,4366.7793,1746,4370.7793,1750,4366.7793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="4366.7793" y2="4366.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="4362.0371">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1386" y="4362.0371">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1704,4409.7793,1821,4409.7793,1831,4428.7793,1821,4447.7793,1704,4447.7793,1694,4428.7793,1704,4409.7793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1706" y="4426.3477">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1706" y="4441.6582">transferExtension</text><polygon fill="#A80036" points="393,4470.7109,383,4474.7109,393,4478.7109,389,4474.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="4474.7109" y2="4474.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="4469.9688">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="4469.9688">Return success</text><path d="M308,4496.7109 L370,4496.7109 L370,4503.7109 L360,4513.7109 L308,4513.7109 L308,4496.7109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1266.8535" style="stroke: #000000; stroke-width: 2.0;" width="1550" x="308" y="4496.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="323" y="4510.2793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="385" y="4509.3457">[Transfer.ilpCondition validate successful]</text><path d="M318,4521.0215 L774,4521.0215 L774,4528.0215 L764,4538.0215 L318,4538.0215 L318,4521.0215 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1530" x="318" y="4521.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="333" y="4534.5898">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1335,4570.9531,1345,4574.9531,1335,4578.9531,1339,4574.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1341" y1="4574.9531" y2="4574.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="4562.5557">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="4554.9004">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="4570.2109">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="4570.2109">2003</text><polygon fill="#A80036" points="1746,4600.2637,1756,4604.2637,1746,4608.2637,1750,4604.2637" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1357" x2="1752" y1="4604.2637" y2="4604.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="4599.5215">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1386" y="4599.5215">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fqhcfjpcp8f7)" points="1697,4647.2637,1828,4647.2637,1838,4658.2637,1828,4670.2637,1697,4670.2637,1687,4658.2637,1697,4647.2637" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1699" y="4663.832">transferStateChange</text><polygon fill="#A80036" points="393,4692.8848,383,4696.8848,393,4700.8848,389,4696.8848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1351" y1="4696.8848" y2="4696.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="4692.1426">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="4692.1426">Return success</text><path d="M318,4718.8848 L380,4718.8848 L380,4725.8848 L370,4735.8848 L318,4735.8848 L318,4718.8848 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="933.793" style="stroke: #000000; stroke-width: 2.0;" width="657" x="318" y="4718.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="333" y="4732.4531">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="395" y="4731.5195">[If type == 'fulfil']</text><path d="M387,4741.1953 L387,5118.1953 L696,5118.1953 L696,4751.1953 L686,4741.1953 L387,4741.1953 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,4741.1953 L686,4751.1953 L696,4751.1953 L686,4741.1953 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="4758.7637">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="4774.0742">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="4789.3848">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="4804.6953">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="4820.0059">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="4835.3164">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="4850.627">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="4865.9375">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="4881.248">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="4896.5586">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="4911.8691">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="4927.1797">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="4942.4902">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="4957.8008">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="4973.1113">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="4988.4219">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="5003.7324">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="5019.043">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="5034.3535">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="5049.6641">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="5064.9746">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="5080.2852">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="5095.5957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="5110.9063">}</text><polygon fill="#A80036" points="878,5144.959,888,5148.959,878,5152.959,882,5148.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="884" y1="5148.959" y2="5148.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="5144.2168">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="411" y="5144.2168">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="318" x2="975" y1="5187.959" y2="5187.959"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="323" y="5198.5938">[If type == 'bulk-fulfil']</text><path d="M387,5206.9141 L387,5583.9141 L696,5583.9141 L696,5216.9141 L686,5206.9141 L387,5206.9141 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,5206.9141 L686,5216.9141 L696,5216.9141 L686,5206.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="5224.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="5239.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="5255.1035">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="5270.4141">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="5285.7246">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="5301.0352">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="5316.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="5331.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="5346.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="5362.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="5377.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="5392.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="5408.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="5423.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="441" y="5438.8301">type: bulk-position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="5454.1406">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="5469.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="5484.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="5500.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="5515.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="5530.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="5546.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="5561.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="5576.625">}</text><polygon fill="#A80036" points="878,5610.6777,888,5614.6777,878,5618.6777,882,5614.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="884" y1="5614.6777" y2="5614.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="5609.9355">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="411" y="5609.9355">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="308" x2="1858" y1="5660.6777" y2="5660.6777"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="313" y="5671.3125">[Validate Fulfil Transfer not successful]</text><path d="M318,5681.6328 L402,5681.6328 L402,5688.6328 L392,5698.6328 L318,5698.6328 L318,5681.6328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="382" x="318" y="5681.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="333" y="5695.2012">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="5735.5645" y2="5735.5645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="5735.5645" y2="5748.5645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="5748.5645" y2="5748.5645"/><polygon fill="#A80036" points="393,5744.5645,383,5748.5645,393,5752.5645,389,5748.5645" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="5723.167">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="411" y="5715.5117">Route &amp; Publish Notification event for Payee</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="411" y="5730.8223">Reference: Failure in validation</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1928" y1="5778.5645" y2="5778.5645"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="5789.1992">[Consume Batch Messages]</text><path d="M149,5797.5195 L149,5822.5195 L363,5822.5195 L363,5807.5195 L353,5797.5195 L149,5797.5195 " fill="#ADD8E6" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,5797.5195 L353,5807.5195 L363,5807.5195 L353,5797.5195 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="155" y="5815.0879">To be delivered by future story</text><path d="M308,5852.8301 L562,5852.8301 L562,5859.8301 L552,5869.8301 L308,5869.8301 L308,5852.8301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="980.4141" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="308" y="5852.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="323" y="5866.3984">Reference: Failure in validation</text><path d="M318,5877.1406 L380,5877.1406 L380,5884.1406 L370,5894.1406 L318,5894.1406 L318,5877.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="949.1035" style="stroke: #000000; stroke-width: 2.0;" width="986" x="318" y="5877.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="333" y="5890.709">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="395" y="5889.7754">[If type == 'bulk-fulfil']</text><path d="M387,5899.4512 L387,6276.4512 L696,6276.4512 L696,5909.4512 L686,5899.4512 L387,5899.4512 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,5899.4512 L686,5909.4512 L696,5909.4512 L686,5899.4512 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="5917.0195">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="5932.3301">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="5947.6406">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="5962.9512">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="5978.2617">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="5993.5723">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="6008.8828">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="6024.1934">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="6039.5039">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="6054.8145">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="6070.125">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="6085.4355">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="6100.7461">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="6116.0566">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="441" y="6131.3672">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="6146.6777">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="6161.9883">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="6177.2988">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="6192.6094">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="6207.9199">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="6223.2305">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="6238.541">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="6253.8516">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="6269.1621">}</text><polygon fill="#A80036" points="1099.5,6318.5254,1109.5,6322.5254,1099.5,6326.5254,1103.5,6322.5254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1105.5" y1="6322.5254" y2="6322.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="6310.1279">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="411" y="6302.4727">Publish Notification event for Payee to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="6317.7832">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="6317.7832">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="318" x2="1304" y1="6361.5254" y2="6361.5254"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="323" y="6372.1602">[If type == 'fulfil']</text><path d="M387,6380.4805 L387,6757.4805 L696,6757.4805 L696,6390.4805 L686,6380.4805 L387,6380.4805 " fill="#FFFF00" filter="url(#fqhcfjpcp8f7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,6380.4805 L686,6390.4805 L696,6390.4805 L686,6380.4805 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="6398.0488">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="6413.3594">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="6428.6699">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="6443.9805">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="6459.291">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="6474.6016">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="6489.9121">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="6505.2227">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="6520.5332">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="6535.8438">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="6551.1543">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="6566.4648">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="6581.7754">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="6597.0859">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="441" y="6612.3965">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="6627.707">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="6643.0176">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="6658.3281">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="6673.6387">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="6688.9492">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="6704.2598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="6719.5703">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="6734.8809">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="6750.1914">}</text><polygon fill="#A80036" points="1227,6784.2441,1237,6788.2441,1227,6792.2441,1231,6788.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1233" y1="6788.2441" y2="6788.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="6783.502">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="411" y="6783.502">Route &amp; Publish Notification event for Payee</text><!--
@startuml
title 2.2.1. Fulfil Handler Consume (Success) (single message, includes individual transfers from Bulk)

autonumber

collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Handler" as FULF_HANDLER
collections "topic-\nevent" as TOPIC_EVENT
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_BULK_PROCESSING
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type IN ['fulfil','bulk-fulfil'] && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]}
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature** {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg seq-signature-validation]]} \n<color #FF0000><b>Error codes:</b> 3105/3106</color>
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId uuid
            FULF_HANDLER -> POS_DAO: Request to retrieve transfer fulfilment hashes by transferId\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Request Transfer fulfilment duplicate message hashes
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM **transferFulfilmentDuplicateCheck**
                WHERE transferId = request.params.id
            end note
            activate DB
            POS_DAO <- - DB: Return existing hashes
            deactivate DB
            POS_DAO - -> FULF_HANDLER: Return (list of) transfer fulfil messages hash(es)
            deactivate POS_DAO
            FULF_HANDLER -> FULF_HANDLER: Loop the list of returned hashes and compare \neach entry with the calculated message hash
            alt Hash matched
                FULF_HANDLER -> TOPIC_EVENT: Publish event information (for duplicate) \n(Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} )
                FULF_HANDLER -> POS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                POS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate POS_DAO
                alt transferFulfilment.isValid == 0
                    break
                        alt If type == 'fulfil'
                            note right of FULF_HANDLER #yellow
                            Message:
                            {
                                id: <ID>,
                                from: <transferHeaders.FSPIOP-Source>,
                                to: <transferHeaders.FSPIOP-Destination>,
                                type: application/json,
                                content: {
                                    headers: <transferHeaders>,
                                    payload: <transferMessage>
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: notification,
                                        action: fulfil-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "error",
                                            code: 1
                                        }
                                    }
                                }
                            }
                            end note
                            FULF_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event for Payee - Modified Request\n<color #FF0000><b>Error codes:</b> 3106</color>
                            activate TOPIC_NOTIFICATIONS
                            deactivate TOPIC_NOTIFICATIONS
                        else If type == 'bulk-fulfil'
                            note right of FULF_HANDLER #yellow
                            Message:
                            {
                                id: <ID>,
                                from: <transferHeaders.FSPIOP-Source>,
                                to: <transferHeaders.FSPIOP-Destination>,
                                type: application/json,
                                content: {
                                    headers: <transferHeaders>,
                                    payload: <transferMessage>
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: bulk-processing,
                                        action: fulfil-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "error",
                                            code: 1
                                        }
                                    }
                                }
                            }
                            end note
                            FULF_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event for Payee - Modified Request \n3106 to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 3106</color>
                            activate TOPIC_BULK_PROCESSING
                            deactivate TOPIC_BULK_PROCESSING
                        end
                    end
                else transferState IN ['COMMITTED', 'ABORTED']
                    break
                        alt If type == 'fulfil'
                            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Send notification to Participant (Payee) {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg 1.1.4.a]]} \n
                        else If type == 'bulk-fulfil'
                            note right of FULF_HANDLER #yellow
                            Message:
                            {
                                id: <ID>,
                                from: <transferHeaders.FSPIOP-Source>,
                                to: <transferHeaders.FSPIOP-Destination>,
                                type: application/json,
                                content: {
                                    headers: <transferHeaders>,
                                    payload: <transferMessage>
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: bulk-processing,
                                        action: fulfil-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "success",
                                            code: 1
                                        }
                                    }
                                }
                            }
                            end note
                            FULF_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event for Payee to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
                            activate TOPIC_BULK_PROCESSING
                            deactivate TOPIC_BULK_PROCESSING
                        end
                    end
                else transferState NOT 'RESERVED'
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color Magenta><b>Reference: Failure in validation</b></color>\n<color #FF0000><b>Error code:</b> 2001</color>
                    end
                else
                    break
                        alt If type == 'fulfil'
                            FULF_HANDLER <-> FULF_HANDLER: Allow previous request to complete
                        else If type == 'bulk-fulfil'
                            note right of FULF_HANDLER #yellow
                            Message:
                            {
                                id: <ID>,
                                from: <transferHeaders.FSPIOP-Source>,
                                to: <transferHeaders.FSPIOP-Destination>,
                                type: application/json,
                                content: {
                                    headers: <transferHeaders>,
                                    payload: <transferMessage>
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: bulk-processing,
                                        action: fulfil-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "success",
                                            code: 1
                                        }
                                    }
                                }
                            }
                            end note
                            FULF_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event for Payee to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
                            activate TOPIC_BULK_PROCESSING
                            deactivate TOPIC_BULK_PROCESSING
                        end
                    end
                end
            else Hash not matched
                FULF_HANDLER -> POS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return success
                deactivate POS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Fetch from database
            activate DB
            hnote over DB #lightyellow
                transfer
            end note
            DB - -> POS_DAO
            deactivate DB
            FULF_HANDLER <- - POS_DAO: Return transfer
            deactivate POS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
            FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

            opt Transfer.ilpCondition validate successful
                group Request current Settlement Window
                    FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    DB - -> POS_DAO
                    deactivate DB
                    FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                    deactivate POS_DAO
                end
            end

            group Persist fulfilment
                FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - POS_DAO: Return success
                deactivate POS_DAO
            end

            alt Transfer.ilpCondition validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    POS_DAO - -> FULF_HANDLER: Return success
                    deactivate POS_DAO
                end

                alt If type == 'fulfil'
                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                else If type == 'bulk-fulfil'
                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: bulk-position,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                end
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> FULF_HANDLER: Route & Publish Notification event for Payee\n<color Magenta><b>Reference: Failure in validation</b></color>
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end

group Reference: Failure in validation
    alt If type == 'bulk-fulfil'
        note right of FULF_HANDLER #yellow
        Message:
        {
            id: <ID>,
            from: <transferHeaders.FSPIOP-Source>,
            to: <transferHeaders.FSPIOP-Destination>,
            type: application/json,
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: bulk-processing,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "error",
                        code: 1
                    }
                }
            }
        }
        end note
        FULF_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event for Payee to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_BULK_PROCESSING
        deactivate TOPIC_BULK_PROCESSING
    else If type == 'fulfil'
        note right of FULF_HANDLER #yellow
        Message:
        {
            id: <ID>,
            from: <transferHeaders.FSPIOP-Source>,
            to: <transferHeaders.FSPIOP-Destination>,
            type: application/json,
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "error",
                        code: 1
                    }
                }
            }
        }
        end note
        FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end

deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>